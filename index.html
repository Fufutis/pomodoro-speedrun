<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Sequential Speedrunning Pomodoro (Session-Based)</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            background: #fafafa;
        }

        h1 {
            text-align: center;
        }

        .timers {
            text-align: center;
            margin: 30px 0;
        }

        /* The current task timer: big, bold */
        #currentTaskTimer {
            font-size: 4rem;
            font-weight: bold;
            margin: 10px 0;
        }

        /* The total timer: smaller */
        #totalTimer {
            font-size: 1.5rem;
            margin: 5px 0;
        }

        .negative {
            color: red !important;
        }

        #controls {
            text-align: center;
            margin: 10px 0;
        }

        #addTaskBtn,
        #startAllBtn,
        #finishCurrentBtn {
            padding: 10px 20px;
            font-size: 1rem;
            cursor: pointer;
            margin: 5px;
        }

        .task-list {
            margin: 0 auto;
            max-width: 600px;
        }

        .task-row {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #fff;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
        }

        .task-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .task-name-label {
            font-weight: bold;
        }

        .task-row input[type="text"],
        .task-row input[type="number"] {
            width: 140px;
            padding: 5px;
            font-size: 1rem;
        }
    </style>
</head>

<body>

    <h1>Sequential Speedrunning Pomodoro (Session-Based)</h1>

    <div class="timers">
        <!-- Big "current" timer -->
        <div id="currentTaskTimer">00:00</div>
        <!-- Smaller "total" timer -->
        <div id="totalTimer">Total: 00:00</div>
    </div>

    <div id="controls">
        <button id="addTaskBtn">Add Task</button>
        <button id="startAllBtn">Start All</button>
        <button id="finishCurrentBtn" disabled>Finish Current Task</button>
    </div>

    <div class="task-list" id="taskContainer"></div>

    <script>
        /************************************************************************
         * SESSION DATA STRUCTURE
         *
         * We'll store and restore the following in sessionStorage:
         * {
         *   tasks: [
         *     { name: string, minutes: number }
         *   ],
         *   currentTaskIndex: number,
         *   currentTaskEndTime: number|null,  // ms timestamp
         *   totalEndTime: number|null,        // ms timestamp
         *   isSequenceRunning: boolean,       // did we press StartAll?
         * }
         ************************************************************************/

        let currentTaskInterval = null;
        let totalTimerInterval = null;

        /** In-memory data we sync with sessionStorage. **/
        let sessionData = {
            tasks: [],
            currentTaskIndex: -1,     // which task is active
            currentTaskEndTime: null, // when current task hits 0 ms
            totalEndTime: null,       // when total hits 0 ms
            isSequenceRunning: false
        };

        /** We'll keep an array of DOM references. 
         *  Each entry matches sessionData.tasks[index].
         */
        const taskDOMs = []; // { row, nameInput, minInput }

        /************************************************************************
         * ON PAGE LOAD
         ************************************************************************/
        window.addEventListener('DOMContentLoaded', () => {
            loadSessionData();
            initUIFromSession();
            setupEventHandlers();
        });

        /************************************************************************
         * SETUP EVENT HANDLERS
         ************************************************************************/
        function setupEventHandlers() {
            document.getElementById('addTaskBtn').addEventListener('click', addTask);
            document.getElementById('startAllBtn').addEventListener('click', startAll);
            document.getElementById('finishCurrentBtn').addEventListener('click', finishCurrentTask);
        }

        /************************************************************************
         * LOAD SESSION DATA
         ************************************************************************/
        function loadSessionData() {
            const saved = sessionStorage.getItem('seqPomodoroData');
            if (!saved) {
                return; // no saved data
            }
            const parsed = JSON.parse(saved);

            // Merge into sessionData
            sessionData.tasks = parsed.tasks || [];
            sessionData.currentTaskIndex = parsed.currentTaskIndex ?? -1;
            sessionData.currentTaskEndTime = parsed.currentTaskEndTime ?? null;
            sessionData.totalEndTime = parsed.totalEndTime ?? null;
            sessionData.isSequenceRunning = parsed.isSequenceRunning ?? false;
        }

        /************************************************************************
         * SAVE SESSION DATA
         ************************************************************************/
        function saveSessionData() {
            sessionStorage.setItem('seqPomodoroData', JSON.stringify(sessionData));
        }

        /************************************************************************
         * INIT UI FROM SESSION
         * 1) Rebuild the task rows from sessionData.tasks
         * 2) If isSequenceRunning, re-init intervals for current & total timers
         ************************************************************************/
        function initUIFromSession() {
            // Rebuild tasks
            for (let i = 0; i < sessionData.tasks.length; i++) {
                const t = sessionData.tasks[i];
                createTaskRow(t.name, t.minutes);
            }

            // If we have tasks, possibly update the "Finish Current" button
            if (sessionData.currentTaskIndex >= 0 && sessionData.currentTaskIndex < sessionData.tasks.length) {
                document.getElementById('finishCurrentBtn').disabled = false;
            }

            // If the sequence was running, re-init intervals
            if (sessionData.isSequenceRunning) {
                // Start total timer if needed
                if (sessionData.totalEndTime) {
                    startTotalTimerInterval();
                }
                // Start current task timer if needed
                if (sessionData.currentTaskIndex >= 0 && sessionData.currentTaskIndex < sessionData.tasks.length) {
                    startCurrentTaskInterval();
                } else if (sessionData.currentTaskIndex >= sessionData.tasks.length) {
                    // Means "All done"
                    document.getElementById('currentTaskTimer').textContent = 'ALL DONE';
                    document.getElementById('finishCurrentBtn').disabled = true;
                }
            }

            // Immediately update timer displays
            updateCurrentTaskTimerDisplay();
            updateTotalTimerDisplay();
        }

        /************************************************************************
         * CREATE TASK ROW (DOM)
         * If name/minutes are given, we populate them, otherwise empty
         ************************************************************************/
        function createTaskRow(nameVal = '', minsVal = '') {
            const row = document.createElement('div');
            row.classList.add('task-row');

            const taskInfo = document.createElement('div');
            taskInfo.classList.add('task-info');

            // Task Name
            const nameLabel = document.createElement('label');
            nameLabel.classList.add('task-name-label');
            nameLabel.textContent = 'Task Name: ';
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.value = nameVal;
            nameInput.placeholder = 'My Task';

            // Task Minutes
            const minLabel = document.createElement('label');
            minLabel.textContent = 'Minutes: ';
            const minInput = document.createElement('input');
            minInput.type = 'number';
            minInput.min = '1';
            minInput.value = minsVal;
            minInput.placeholder = '5';

            taskInfo.appendChild(nameLabel);
            taskInfo.appendChild(nameInput);
            taskInfo.appendChild(minLabel);
            taskInfo.appendChild(minInput);
            row.appendChild(taskInfo);

            document.getElementById('taskContainer').appendChild(row);

            // Keep references
            taskDOMs.push({ row, nameInput, minInput });
        }

        /************************************************************************
         * ADD TASK BUTTON HANDLER
         * 1) Create DOM row
         * 2) Add blank entry to sessionData.tasks
         * 3) Save
         ************************************************************************/
        function addTask() {
            createTaskRow();

            // Also push to sessionData
            sessionData.tasks.push({ name: '', minutes: 5 });
            saveSessionData();
        }

        /************************************************************************
         * START ALL (SEQUENCE)
         * 1) Validate tasks
         * 2) Calculate totalEndTime
         * 3) currentTaskIndex = 0 => set currentTaskEndTime
         * 4) Start intervals
         ************************************************************************/
        function startAll() {
            if (sessionData.tasks.length === 0) {
                alert('Please add at least one task first.');
                return;
            }

            // Validate
            let totalMins = 0;
            for (let i = 0; i < taskDOMs.length; i++) {
                const name = taskDOMs[i].nameInput.value.trim();
                const mins = parseInt(taskDOMs[i].minInput.value, 10);

                if (!name || isNaN(mins) || mins <= 0) {
                    alert('All tasks must have a valid name and positive minutes.');
                    return;
                }
            }

            // Save updated name/minutes from DOM into sessionData
            for (let i = 0; i < sessionData.tasks.length; i++) {
                sessionData.tasks[i].name = taskDOMs[i].nameInput.value.trim();
                sessionData.tasks[i].minutes = parseInt(taskDOMs[i].minInput.value, 10);
                totalMins += sessionData.tasks[i].minutes;
            }

            const now = Date.now();
            // totalEndTime
            sessionData.totalEndTime = now + totalMins * 60 * 1000;
            // currentTaskIndex => 0
            sessionData.currentTaskIndex = 0;
            // currentTaskEndTime => now + (minutes of first task)
            if (sessionData.tasks.length > 0) {
                const firstTaskMins = sessionData.tasks[0].minutes;
                sessionData.currentTaskEndTime = now + firstTaskMins * 60 * 1000;
            }
            sessionData.isSequenceRunning = true;

            // Clear old intervals if any
            if (totalTimerInterval) clearInterval(totalTimerInterval);
            if (currentTaskInterval) clearInterval(currentTaskInterval);

            // Start intervals
            startTotalTimerInterval();
            startCurrentTaskInterval();

            // Enable "Finish Current Task"
            document.getElementById('finishCurrentBtn').disabled = false;

            // Save
            saveSessionData();
        }

        /************************************************************************
         * START CURRENT TASK INTERVAL
         ************************************************************************/
        function startCurrentTaskInterval() {
            if (currentTaskInterval) clearInterval(currentTaskInterval);
            currentTaskInterval = setInterval(() => {
                updateCurrentTaskTimerDisplay();
            }, 1000);
            // Update immediately
            updateCurrentTaskTimerDisplay();
        }

        /************************************************************************
         * START TOTAL TIMER INTERVAL
         ************************************************************************/
        function startTotalTimerInterval() {
            if (totalTimerInterval) clearInterval(totalTimerInterval);
            totalTimerInterval = setInterval(() => {
                updateTotalTimerDisplay();
            }, 1000);
            // Update once right away
            updateTotalTimerDisplay();
        }

        /************************************************************************
         * FINISH CURRENT TASK BUTTON
         * Moves to next task, or "ALL DONE" if no tasks left
         ************************************************************************/
        function finishCurrentTask() {
            // Stop current task’s interval
            if (currentTaskInterval) {
                clearInterval(currentTaskInterval);
                currentTaskInterval = null;
            }

            // Move to next
            sessionData.currentTaskIndex++;
            const now = Date.now();

            if (sessionData.currentTaskIndex >= sessionData.tasks.length) {
                // ALL DONE
                document.getElementById('finishCurrentBtn').disabled = true;
                document.getElementById('currentTaskTimer').textContent = 'ALL DONE';
                sessionData.currentTaskEndTime = null;
            } else {
                // Start the next task
                const nextTaskMins = sessionData.tasks[sessionData.currentTaskIndex].minutes;
                sessionData.currentTaskEndTime = now + nextTaskMins * 60 * 1000;
                startCurrentTaskInterval();
            }

            // Save
            saveSessionData();
        }

        /************************************************************************
         * UPDATE CURRENT TASK TIMER DISPLAY
         ************************************************************************/
        function updateCurrentTaskTimerDisplay() {
            const timerElem = document.getElementById('currentTaskTimer');

            // If no current task
            if (sessionData.currentTaskIndex < 0 || sessionData.currentTaskIndex >= sessionData.tasks.length) {
                // No tasks or all done
                return;
            }

            const endTime = sessionData.currentTaskEndTime;
            if (!endTime) {
                // Not set?
                timerElem.textContent = '00:00';
                return;
            }

            const now = Date.now();
            let diffSec = Math.floor((endTime - now) / 1000);

            if (diffSec <= 0) {
                // Negative
                const late = Math.abs(diffSec);
                const mins = Math.floor(late / 60);
                const secs = late % 60;
                timerElem.classList.add('negative');
                timerElem.textContent = `-${padZero(mins)}:${padZero(secs)}`;
            } else {
                // Positive
                const mins = Math.floor(diffSec / 60);
                const secs = diffSec % 60;
                timerElem.classList.remove('negative');
                timerElem.textContent = `${padZero(mins)}:${padZero(secs)}`;
            }
        }

        /************************************************************************
         * UPDATE TOTAL TIMER DISPLAY
         ************************************************************************/
        function updateTotalTimerDisplay() {
            const totalElem = document.getElementById('totalTimer');
            if (!sessionData.totalEndTime) {
                totalElem.textContent = 'Total: 00:00';
                return;
            }

            const now = Date.now();
            let diffSec = Math.floor((sessionData.totalEndTime - now) / 1000);

            if (diffSec <= 0) {
                // Negative
                const late = Math.abs(diffSec);
                const mins = Math.floor(late / 60);
                const secs = late % 60;
                totalElem.classList.add('negative');
                totalElem.textContent = `Total: -${padZero(mins)}:${padZero(secs)}`;
            } else {
                // Positive
                const mins = Math.floor(diffSec / 60);
                const secs = diffSec % 60;
                totalElem.classList.remove('negative');
                totalElem.textContent = `Total: ${padZero(mins)}:${padZero(secs)}`;
            }
        }

        /************************************************************************
         * HELPER: padZero
         ************************************************************************/
        function padZero(num) {
            return num < 10 ? '0' + num : num;
        }
    </script>
</body>

</html>